<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin - Booked Data</title>
    <style>
        body { font-family: sans-serif; padding: 20px; color: #333; background-color: #f9f9f9; }
        h1, h2, h3 { text-align: center; }
        h1 { margin-bottom: 2rem; }
        h2 { color: #de493c; border-top: 2px solid #ddd; padding-top: 20px; margin-top: 40px;}
        h3 {
            text-align: left; background-color: #333; color: white;
            padding: 10px 15px; margin-top: 30px; margin-bottom: 0;
            border-radius: 8px 8px 0 0;
        }
        table {
            width: 100%; border-collapse: collapse; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px; /* Add space below each table */
        }
        th, td { border: 1px solid #ccc; padding: 10px; text-align: left; background-color: white; }
        th { background-color: #f2f2f2; }
        tfoot td { font-weight: bold; background-color: #f9f9f9; }
        .export-btn {
            display: block; width: 200px; margin: 20px auto; padding: 10px 15px;
            background-color: #1D6F42; color: white; border: none; border-radius: 5px;
            font-size: 1rem; cursor: pointer; text-align: center;
        }
        .export-btn:hover { background-color: #144D2D; }
        .discount-row { color: #28a745; }
        .icon-btn {
            background: none; border: none; cursor: pointer; padding: 5px;
            display: inline-flex; align-items: center; justify-content: center;
            vertical-align: middle; /* Align icons nicely */
        }
        .icon-btn svg { width: 20px; height: 20px; }
        .unbook-btn svg { fill: #de493c; }
        .unbook-btn:hover svg { fill: #b03a2e; }
        .save-btn svg { fill: #007bff; }
        .save-btn:hover svg { fill: #0056b3; }
        .recalculate-input {
            width: 100px; padding: 5px; border: 1px solid #ccc; border-radius: 4px;
            margin-right: 5px; /* Add space before save button */
        }
        .action-cell { /* Center align action buttons */
            text-align: center;
        }
        .footer-cell { /* Align text right in footer */
             text-align: right;
        }
        /* Styles for filters */
        .filter-container {
            background-color: #fff;
            padding: 15px 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap; /* Allow filters to wrap on smaller screens */
        }
        .filter-container label {
            font-weight: bold;
            margin-right: 5px;
        }
        .filter-container select, .filter-container input {
            padding: 8px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .filter-container button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: white;
        }
        .filter-btn { background-color: #007bff; }
        .filter-btn:hover { background-color: #0056b3; }
        .clear-btn { background-color: #6c757d; }
        .clear-btn:hover { background-color: #5a6268; }
    </style>
</head>
<body>
    <h1>Booked Positions Management</h1>

    <button id="export-btn" class="export-btn">Export to Excel</button>

    <div class="filter-container">
        <label for="filter-brand">Filter by Brand:</label>
        <select id="filter-brand">
            <option value="">All Brands</option>
            </select>

        <label for="filter-zone">Filter by Zone:</label>
        <select id="filter-zone">
            <option value="">All Zones</option>
            </select>

        <button id="filter-btn" class="filter-btn">Apply Filter</button>
        <button id="clear-btn" class="clear-btn">Clear Filter</button>
    </div>

    <div id="brands-container"></div>

    <h2 id="total-revenue">Total Revenue After Discount: Calculating...</h2>

    <script>
        // Store the full dataset globally to avoid refetching
        let allBookingsData = {};
        let uniqueBrands = new Set();
        let uniqueZones = new Set();

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('export-btn').addEventListener('click', () => {
                // Fetch using API path for Netlify
                window.location.href = '/api/export-excel';
            });
            // Add listeners for filter buttons
            document.getElementById('filter-btn').addEventListener('click', renderFilteredBookings);
            document.getElementById('clear-btn').addEventListener('click', clearFiltersAndRender);

            fetchBookings(); // Initial fetch
        });

        async function unbookSpot(zoneId, spotId) {
            if (!confirm("Are you sure you want to make this position available again?")) return;
            try {
                // Fetch using API path for Netlify
                const response = await fetch('/api/unbook', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ zoneId, spotId })
                });
                const result = await response.json();
                alert(result.message);
                if (response.ok) fetchBookings(); // Refresh data on success
            } catch (error) {
                console.error("Unbook Error:", error);
                alert('A network error occurred while trying to un-book.');
            }
        }

        async function saveDiscount(brandName) {
            const brandTable = document.querySelector(`table[data-brand="${brandName}"]`);
            const moreDiscountInput = brandTable.querySelector('.recalculate-input');
            const moreDiscount = parseFloat(moreDiscountInput.value) || 0;

            try {
                // Fetch using API path for Netlify
                const response = await fetch('/api/apply-discount', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ brandName, moreDiscount })
                });
                const result = await response.json();
                alert(result.message);
                if (response.ok) fetchBookings(); // Refresh data to show saved value
            } catch (error) {
                console.error("Save Discount Error:", error);
                alert('A network error occurred while saving the discount.');
            }
        }

        function recalculateTotals() {
            let overallTotalRevenue = 0;
            const brandTables = document.querySelectorAll('.brand-table');

            brandTables.forEach(table => {
                const brandSubtotal = parseFloat(table.dataset.subtotal);
                const autoDiscount = parseFloat(table.dataset.autodiscount);

                const moreDiscountInput = table.querySelector('.recalculate-input');
                const moreDiscount = parseFloat(moreDiscountInput.value) || 0;

                const brandTotal = brandSubtotal - autoDiscount - moreDiscount;

                table.querySelector('.brand-total-display').textContent = `${brandTotal.toLocaleString()} THB`;
                overallTotalRevenue += brandTotal;
            });

            document.getElementById('total-revenue').textContent = `Total Revenue After Discount: ${overallTotalRevenue.toLocaleString()} THB`;
        }

        function populateFilterDropdowns() {
            const brandSelect = document.getElementById('filter-brand');
            const zoneSelect = document.getElementById('filter-zone');

            // Clear existing options except the "All" default
            brandSelect.innerHTML = '<option value="">All Brands</option>';
            zoneSelect.innerHTML = '<option value="">All Zones</option>';

            // Add unique brand names (sorted)
            Array.from(uniqueBrands).sort().forEach(brand => {
                const option = document.createElement('option');
                option.value = brand;
                option.textContent = brand;
                brandSelect.appendChild(option);
            });

            // Add unique zone names (sorted)
            Array.from(uniqueZones).sort().forEach(zone => {
                 const option = document.createElement('option');
                option.value = zone; // Using zone name directly as value
                option.textContent = zone;
                zoneSelect.appendChild(option);
            });
        }

        async function fetchBookings() {
            try {
                // Fetch using API path for Netlify and prevent caching
                const response = await fetch('/api/admin-data', {
                    cache: 'no-cache',
                    headers: { 'Cache-Control': 'no-cache', 'Pragma': 'no-cache' }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                allBookingsData = await response.json(); // Store the full data
                uniqueBrands.clear();
                uniqueZones.clear();

                // Extract unique brands and zones for filters
                for (const zoneId in allBookingsData) {
                    const zone = allBookingsData[zoneId];
                    uniqueZones.add(zone.name); // Add zone name
                    for (const spotId in zone.spots) {
                        const spot = zone.spots[spotId];
                        if (spot.status === 'Booked' && spot.brand) {
                            uniqueBrands.add(spot.brand);
                        }
                    }
                }
                
                populateFilterDropdowns(); // Populate dropdowns with fresh data
                renderFilteredBookings(); // Render initially with no filters

            } catch (error) {
                console.error("Failed to fetch booking data:", error);
                document.getElementById('brands-container').innerHTML = `<p style="color:red;">Error loading data: ${error.message}. Please try again.</p>`;
                document.getElementById('total-revenue').textContent = "Error loading data.";
            }
        }

        function clearFiltersAndRender() {
            document.getElementById('filter-brand').value = '';
            document.getElementById('filter-zone').value = '';
            renderFilteredBookings();
        }

        // Renders bookings based on selected filters
        function renderFilteredBookings() {
            const selectedBrand = document.getElementById('filter-brand').value;
            const selectedZone = document.getElementById('filter-zone').value;

            const brandsContainer = document.getElementById('brands-container');
            brandsContainer.innerHTML = '';
            let overallTotalRevenue = 0;
            const bookingsByBrand = {};

            // 1. Filter and group data based on selections
            for (const zoneId in allBookingsData) {
                const zone = allBookingsData[zoneId];
                if (selectedZone && zone.name !== selectedZone) continue; // Skip zone if not matching

                for (const spotId in zone.spots) {
                    const spot = zone.spots[spotId];
                    if (spot.status === 'Booked' && (!selectedBrand || spot.brand === selectedBrand)) {
                        const brandName = spot.brand || 'Unknown Brand';
                        if (!bookingsByBrand[brandName]) {
                            bookingsByBrand[brandName] = [];
                        }
                        bookingsByBrand[brandName].push({ ...spot, zoneId, spotId, zoneName: zone.name });
                    }
                }
            }

            // 2. Build tables
            const sortedBrandNames = Object.keys(bookingsByBrand).sort();
            if (sortedBrandNames.length === 0) {
                 brandsContainer.innerHTML = "<p>No bookings match the current filter.</p>";
            }

            for (const brandName of sortedBrandNames) {
                const brandSpots = bookingsByBrand[brandName];
                let brandSubtotal = 0;
                let tableRowsHTML = '';
                let totalManualDiscount = 0;

                brandSpots.forEach(spot => {
                    tableRowsHTML += `
                        <tr>
                            <td>${spot.zoneName}</td>
                            <td>${spot.name}</td>
                            <td>${spot.price.toLocaleString()} THB</td>
                            <td>${spot.bookedBy}</td>
                            <td class="action-cell">
                                <button class="icon-btn unbook-btn" onclick="unbookSpot('${spot.zoneId}', '${spot.spotId}')" title="Un-book">
                                    <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"></path></svg>
                                </button>
                            </td>
                        </tr>
                    `;
                    brandSubtotal += spot.price;
                    totalManualDiscount = spot.manualDiscount || 0; // Use saved discount
                });

                let autoDiscount = 0;
                if (brandSpots.length === 2) autoDiscount = 5000;
                else if (brandSpots.length >= 3) autoDiscount = 10000;

                // --- Corrected Footer Structure ---
                const tfootHTML = `
                    <tr>
                        <td colspan="4" class="footer-cell">Subtotal:</td>
                        <td>${brandSubtotal.toLocaleString()} THB</td>
                    </tr>
                    ${autoDiscount > 0 ? `
                    <tr class="discount-row">
                        <td colspan="4" class="footer-cell">Auto Discount:</td>
                        <td>-${autoDiscount.toLocaleString()} THB</td>
                    </tr>` : ''}
                    <tr>
                        <td colspan="3" class="footer-cell">More Discount:</td>
                        <td><input type="number" class="recalculate-input" value="${totalManualDiscount}" placeholder="0"> THB</td>
                        <td class="action-cell">
                            <button class="icon-btn save-btn" onclick="saveDiscount('${brandName}')" title="Save Discount">
                                <svg viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"></path></svg>
                            </button>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="4" class="footer-cell"><strong>Brand Total:</strong></td>
                        <td><strong class="brand-total-display"></strong></td>
                    </tr>
                `;
                // --- End Corrected Footer ---

                const brandSectionHTML = `
                    <h3>Brand: ${brandName}</h3>
                    <table class="brand-table" data-brand="${brandName}" data-subtotal="${brandSubtotal}" data-autodiscount="${autoDiscount}">
                        <thead>
                            <tr>
                                <th>Zone</th>
                                <th>Position Name</th>
                                <th>Price</th>
                                <th>Booked By (Email)</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>${tableRowsHTML}</tbody>
                        <tfoot>${tfootHTML}</tfoot>
                    </table>
                `;
                brandsContainer.innerHTML += brandSectionHTML;
            }

            // Attach listeners and recalculate totals for the filtered view
            document.querySelectorAll('.recalculate-input').forEach(input => {
                input.addEventListener('input', recalculateTotals);
            });
            recalculateTotals(); // Calculate initial totals based on the filtered data

        } // End of renderFilteredBookings
    </script>
</body>
</html>