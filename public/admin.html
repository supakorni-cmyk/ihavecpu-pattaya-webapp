<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin - Booked Data</title>
    <style>
        /* ... (Keep existing styles) ... */
        /* NEW STYLES for filters */
        .filter-container {
            background-color: #fff;
            padding: 15px 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap; /* Allow filters to wrap on smaller screens */
        }
        .filter-container label {
            font-weight: bold;
            margin-right: 5px;
        }
        .filter-container select, .filter-container input {
            padding: 8px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .filter-container button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: white;
        }
        .filter-btn { background-color: #007bff; }
        .filter-btn:hover { background-color: #0056b3; }
        .clear-btn { background-color: #6c757d; }
        .clear-btn:hover { background-color: #5a6268; }
    </style>
</head>
<body>
    <h1>Booked Positions Management</h1>

    <button id="export-btn" class="export-btn">Export to Excel</button>

    <div class="filter-container">
        <label for="filter-brand">Filter by Brand:</label>
        <select id="filter-brand">
            <option value="">All Brands</option>
            </select>

        <label for="filter-zone">Filter by Zone:</label>
        <select id="filter-zone">
            <option value="">All Zones</option>
            </select>

        <button id="filter-btn" class="filter-btn">Apply Filter</button>
        <button id="clear-btn" class="clear-btn">Clear Filter</button>
    </div>

    <div id="brands-container"></div>

    <h2 id="total-revenue">Total Revenue After Discount: Calculating...</h2>

    <script>
        // Store the full dataset globally to avoid refetching
        let allBookingsData = {};
        let uniqueBrands = new Set();
        let uniqueZones = new Set();

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('export-btn').addEventListener('click', () => {
                window.location.href = '/api/export-excel';
            });
            // Add listeners for filter buttons
            document.getElementById('filter-btn').addEventListener('click', renderFilteredBookings);
            document.getElementById('clear-btn').addEventListener('click', clearFiltersAndRender);

            fetchBookings(); // Initial fetch
        });

        async function unbookSpot(zoneId, spotId) {
            // ... (unbookSpot function remains the same) ...
        }

        async function saveDiscount(brandName) {
            // ... (saveDiscount function remains the same) ...
        }

        function recalculateTotals() {
            // ... (recalculateTotals function remains the same) ...
        }

        function populateFilterDropdowns() {
            const brandSelect = document.getElementById('filter-brand');
            const zoneSelect = document.getElementById('filter-zone');

            // Clear existing options except the "All" default
            brandSelect.innerHTML = '<option value="">All Brands</option>';
            zoneSelect.innerHTML = '<option value="">All Zones</option>';

            // Add unique brand names
            uniqueBrands.forEach(brand => {
                const option = document.createElement('option');
                option.value = brand;
                option.textContent = brand;
                brandSelect.appendChild(option);
            });

            // Add unique zone names
            uniqueZones.forEach(zone => {
                 const option = document.createElement('option');
                option.value = zone; // Using zone name directly as value
                option.textContent = zone;
                zoneSelect.appendChild(option);
            });
        }

        async function fetchBookings() {
            try {
                const response = await fetch('/api/admin-data', {
                    cache: 'no-cache', headers: { 'Cache-Control': 'no-cache', 'Pragma': 'no-cache' }
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                allBookingsData = await response.json(); // Store the full data
                uniqueBrands.clear();
                uniqueZones.clear();

                // Extract unique brands and zones for filters
                for (const zoneId in allBookingsData) {
                    const zone = allBookingsData[zoneId];
                    uniqueZones.add(zone.name); // Add zone name
                    for (const spotId in zone.spots) {
                        const spot = zone.spots[spotId];
                        if (spot.status === 'Booked' && spot.brand) {
                            uniqueBrands.add(spot.brand);
                        }
                    }
                }
                
                populateFilterDropdowns(); // Populate dropdowns with fresh data
                renderFilteredBookings(); // Render initially with no filters

            } catch (error) {
                console.error("Failed to fetch booking data:", error);
                document.getElementById('brands-container').innerHTML = `<p style="color:red;">Error loading data: ${error.message}. Please try again.</p>`;
                document.getElementById('total-revenue').textContent = "Error loading data.";
            }
        }

        function clearFiltersAndRender() {
            document.getElementById('filter-brand').value = '';
            document.getElementById('filter-zone').value = '';
            renderFilteredBookings();
        }

        // NEW function to render bookings based on selected filters
        function renderFilteredBookings() {
            const selectedBrand = document.getElementById('filter-brand').value;
            const selectedZone = document.getElementById('filter-zone').value;

            const brandsContainer = document.getElementById('brands-container');
            brandsContainer.innerHTML = '';
            let overallTotalRevenue = 0;
            const bookingsByBrand = {};

            // 1. Filter and group data based on selections
            for (const zoneId in allBookingsData) {
                const zone = allBookingsData[zoneId];
                // Check if this zone matches the filter (or if no zone filter is selected)
                if (selectedZone && zone.name !== selectedZone) {
                    continue; // Skip this zone if it doesn't match the filter
                }

                for (const spotId in zone.spots) {
                    const spot = zone.spots[spotId];
                    // Check if spot is booked AND matches brand filter (or no brand filter)
                    if (spot.status === 'Booked' && (!selectedBrand || spot.brand === selectedBrand)) {
                        const brandName = spot.brand || 'Unknown Brand';
                        if (!bookingsByBrand[brandName]) {
                            bookingsByBrand[brandName] = [];
                        }
                        bookingsByBrand[brandName].push({ ...spot, zoneId, spotId, zoneName: zone.name });
                    }
                }
            }

            // 2. Build tables (same logic as before, but using the filtered data)
            const sortedBrandNames = Object.keys(bookingsByBrand).sort();

            if (sortedBrandNames.length === 0) {
                 brandsContainer.innerHTML = "<p>No bookings match the current filter.</p>";
            }

            for (const brandName of sortedBrandNames) {
                const brandSpots = bookingsByBrand[brandName];
                let brandSubtotal = 0;
                let tableRowsHTML = '';
                let totalManualDiscount = 0;

                brandSpots.forEach(spot => {
                    tableRowsHTML += `<tr><td>${spot.zoneName}</td><td>${spot.name}</td><td>${spot.price.toLocaleString()} THB</td><td>${spot.bookedBy}</td><td class="action-cell"><button class="icon-btn unbook-btn" onclick="unbookSpot('${spot.zoneId}', '${spot.spotId}')" title="Un-book"><svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"></path></svg></button></td></tr>`;
                    brandSubtotal += spot.price;
                    totalManualDiscount = spot.manualDiscount || 0;
                });

                let autoDiscount = 0;
                if (brandSpots.length === 2) autoDiscount = 5000;
                else if (brandSpots.length >= 3) autoDiscount = 10000;

                const tfootHTML = `
                    <tr><td colspan="4" class="footer-cell">Subtotal:</td><td>${brandSubtotal.toLocaleString()} THB</td></tr>
                    ${autoDiscount > 0 ? `<tr class="discount-row"><td colspan="4" class="footer-cell">Auto Discount:</td><td>-${autoDiscount.toLocaleString()} THB</td></tr>` : ''}
                    <tr><td colspan="3" class="footer-cell">More Discount:</td><td><input type="number" class="recalculate-input" value="${totalManualDiscount}" placeholder="0"></td><td class="action-cell"><button class="icon-btn save-btn" onclick="saveDiscount('${brandName}')" title="Save Discount"><svg viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"></path></svg></button></td></tr>
                    <tr><td colspan="4" class="footer-cell"><strong>Brand Total:</strong></td><td><strong class="brand-total-display"></strong></td></tr>
                `;

                const brandSectionHTML = `<h3>Brand: ${brandName}</h3><table class="brand-table" data-brand="${brandName}" data-subtotal="${brandSubtotal}" data-autodiscount="${autoDiscount}"><thead><tr><th>Zone</th><th>Position Name</th><th>Price</th><th>Booked By (Email)</th><th>Action</th></tr></thead><tbody>${tableRowsHTML}</tbody><tfoot>${tfootHTML}</tfoot></table>`;
                brandsContainer.innerHTML += brandSectionHTML;
            }

            // Attach listeners and recalculate totals for the filtered view
            document.querySelectorAll('.recalculate-input').forEach(input => {
                input.addEventListener('input', recalculateTotals);
            });
            recalculateTotals(); // Calculate totals based on the filtered data

        } // End of renderFilteredBookings
    </script>
</body>
</html>