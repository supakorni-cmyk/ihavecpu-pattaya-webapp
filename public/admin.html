<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin - Booked Data</title>
    <style>
        body { font-family: sans-serif; padding: 20px; color: #333; background-color: #f9f9f9; }
        h1, h2, h3 { text-align: center; }
        h1 { margin-bottom: 2rem; }
        h2 { color: #de493c; border-top: 2px solid #ddd; padding-top: 20px; margin-top: 40px;}
        h3 {
            text-align: left; background-color: #333; color: white;
            padding: 10px 15px; margin-top: 30px; margin-bottom: 0;
            border-radius: 8px 8px 0 0;
        }
        table {
            width: 100%; border-collapse: collapse; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px; /* Add space below each table */
        }
        th, td { border: 1px solid #ccc; padding: 10px; text-align: left; background-color: white; }
        th { background-color: #f2f2f2; }
        tfoot td { font-weight: bold; background-color: #f9f9f9; }
        .export-btn {
            display: block; width: 200px; margin: 20px auto; padding: 10px 15px;
            background-color: #1D6F42; color: white; border: none; border-radius: 5px;
            font-size: 1rem; cursor: pointer; text-align: center;
        }
        .export-btn:hover { background-color: #144D2D; }
        .discount-row { color: #28a745; }
        .icon-btn {
            background: none; border: none; cursor: pointer; padding: 5px;
            display: inline-flex; align-items: center; justify-content: center;
            vertical-align: middle; /* Align icons nicely */
        }
        .icon-btn svg { width: 20px; height: 20px; }
        .unbook-btn svg { fill: #de493c; }
        .unbook-btn:hover svg { fill: #b03a2e; }
        .save-btn svg { fill: #007bff; }
        .save-btn:hover svg { fill: #0056b3; }
        .recalculate-input {
            width: 100px; padding: 5px; border: 1px solid #ccc; border-radius: 4px;
            margin-right: 5px; /* Add space before save button */
        }
        .action-cell { /* Center align action buttons */
            text-align: center;
        }
        .footer-cell { /* Align text right in footer */
             text-align: right;
        }
    </style>
</head>
<body>
    <h1>Booked Positions Management</h1>

    <button id="export-btn" class="export-btn">Export to Excel</button>

    <div id="brands-container"></div>

    <h2 id="total-revenue">Total Revenue After Discount: Calculating...</h2>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('export-btn').addEventListener('click', () => {
                // Fetch using API path for Netlify
                window.location.href = '/api/export-excel';
            });
            fetchBookings();
        });

        async function unbookSpot(zoneId, spotId) {
            if (!confirm("Are you sure you want to make this position available again?")) return;
            try {
                // Fetch using API path for Netlify
                const response = await fetch('/api/unbook', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ zoneId, spotId })
                });
                const result = await response.json();
                alert(result.message);
                if (response.ok) fetchBookings(); // Refresh data on success
            } catch (error) {
                console.error("Unbook Error:", error);
                alert('A network error occurred while trying to un-book.');
            }
        }

        async function saveDiscount(brandName) {
            const brandTable = document.querySelector(`table[data-brand="${brandName}"]`);
            const moreDiscountInput = brandTable.querySelector('.recalculate-input');
            const moreDiscount = parseFloat(moreDiscountInput.value) || 0;

            try {
                // Fetch using API path for Netlify
                const response = await fetch('/api/apply-discount', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ brandName, moreDiscount })
                });
                const result = await response.json();
                alert(result.message);
                if (response.ok) fetchBookings(); // Refresh data to show saved value
            } catch (error) {
                console.error("Save Discount Error:", error);
                alert('A network error occurred while saving the discount.');
            }
        }

        function recalculateTotals() {
            let overallTotalRevenue = 0;
            const brandTables = document.querySelectorAll('.brand-table');

            brandTables.forEach(table => {
                const brandSubtotal = parseFloat(table.dataset.subtotal);
                const autoDiscount = parseFloat(table.dataset.autodiscount);

                const moreDiscountInput = table.querySelector('.recalculate-input');
                const moreDiscount = parseFloat(moreDiscountInput.value) || 0;

                const brandTotal = brandSubtotal - autoDiscount - moreDiscount;

                table.querySelector('.brand-total-display').textContent = `${brandTotal.toLocaleString()} THB`;
                overallTotalRevenue += brandTotal;
            });

            document.getElementById('total-revenue').textContent = `Total Revenue After Discount: ${overallTotalRevenue.toLocaleString()} THB`;
        }

        async function fetchBookings() {
            try {
                // Fetch using API path for Netlify and prevent caching
                const response = await fetch('/api/admin-data', {
                    cache: 'no-cache',
                    headers: { 'Cache-Control': 'no-cache', 'Pragma': 'no-cache' }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                const brandsContainer = document.getElementById('brands-container');
                brandsContainer.innerHTML = ''; // Clear previous tables
                let overallTotalRevenue = 0;

                const bookingsByBrand = {};
                for (const zoneId in data) {
                    for (const spotId in data[zoneId].spots) {
                        const spot = data[zoneId].spots[spotId];
                        if (spot.status === 'Booked') {
                            const brandName = spot.brand || 'Unknown Brand';
                            if (!bookingsByBrand[brandName]) {
                                bookingsByBrand[brandName] = [];
                            }
                            bookingsByBrand[brandName].push({ ...spot, zoneId, spotId, zoneName: data[zoneId].name });
                        }
                    }
                }

                // Sort brand names alphabetically for consistent order
                const sortedBrandNames = Object.keys(bookingsByBrand).sort();

                for (const brandName of sortedBrandNames) {
                    const brandSpots = bookingsByBrand[brandName];
                    let brandSubtotal = 0;
                    let tableRowsHTML = '';
                    let totalManualDiscount = 0; // Read saved manual discount

                    brandSpots.forEach(spot => {
                        tableRowsHTML += `
                            <tr>
                                <td>${spot.zoneName}</td>
                                <td>${spot.name}</td>
                                <td>${spot.price.toLocaleString()} THB</td>
                                <td>${spot.bookedBy}</td>
                                <td class="action-cell">
                                    <button class="icon-btn unbook-btn" onclick="unbookSpot('${spot.zoneId}', '${spot.spotId}')" title="Un-book">
                                        <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"></path></svg>
                                    </button>
                                </td>
                            </tr>
                        `;
                        brandSubtotal += spot.price;
                        // Use the manualDiscount from the first spot (it should be the same for all spots of the same brand)
                        totalManualDiscount = spot.manualDiscount || 0;
                    });

                    let autoDiscount = 0;
                    if (brandSpots.length === 2) autoDiscount = 5000;
                    else if (brandSpots.length >= 3) autoDiscount = 10000;

                    const tfootHTML = `
                        <tr>
                            <td colspan="4" class="footer-cell">Subtotal:</td>
                            <td>${brandSubtotal.toLocaleString()} THB</td>
                        </tr>
                        ${autoDiscount > 0 ? `
                        <tr class="discount-row">
                            <td colspan="4" class="footer-cell">Auto Discount:</td>
                            <td>-${autoDiscount.toLocaleString()} THB</td>
                        </tr>` : ''}
                        <tr>
                            <td colspan="3" class="footer-cell">More Discount:</td>
                            <td><input type="number" class="recalculate-input" value="${totalManualDiscount}" placeholder="0"></td>
                            <td class="action-cell">
                                <button class="icon-btn save-btn" onclick="saveDiscount('${brandName}')" title="Save Discount">
                                    <svg viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"></path></svg>
                                </button>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="4" class="footer-cell"><strong>Brand Total:</strong></td>
                            <td><strong class="brand-total-display"></strong></td>
                        </tr>
                    `;

                    // Add data attributes to the table for easy access during recalculation
                    const brandSectionHTML = `
                        <h3>Brand: ${brandName}</h3>
                        <table class="brand-table" data-brand="${brandName}" data-subtotal="${brandSubtotal}" data-autodiscount="${autoDiscount}">
                            <thead>
                                <tr>
                                    <th>Zone</th>
                                    <th>Position Name</th>
                                    <th>Price</th>
                                    <th>Booked By (Email)</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>${tableRowsHTML}</tbody>
                            <tfoot>${tfootHTML}</tfoot>
                        </table>
                    `;
                    brandsContainer.innerHTML += brandSectionHTML;
                }

                // Attach event listeners for LIVE recalculation as user types
                document.querySelectorAll('.recalculate-input').forEach(input => {
                    input.addEventListener('input', recalculateTotals);
                });
                recalculateTotals(); // Calculate initial totals

            } catch (error) {
                console.error("Failed to fetch booking data:", error);
                brandsContainer.innerHTML = `<p style="color:red;">Error loading data: ${error.message}</p>`;
                document.getElementById('total-revenue').textContent = "Error loading data.";
            }
        }
    </script>
</body>
</html>